#!/usr/bin/env sh

# Get the path to pvim
export PVIM="$(dirname "$(readlink -e -- "$0")")"

## TODO: check x86 or arm

downloadAppimage() {
  if $appimageNeeded && [ "$imageLocation" = "$PVIM/nvim.appimage" ]; then
    appimageNeeded=false
    echo "Downloading latest Neovim"
    [ -f "$imageLocation" ] && rm "$imageLocation"
    curl -Lo "$imageLocation" https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.appimage && chmod u+x "$imageLocation"
  fi
}

updatepvim() {
  echo "Updating pvim"
  git --git-dir="$PVIM/.git" --work-tree="$PVIM" pull

  echo "Updating the config"
  git --git-dir="$PVIM/config/.git" --work-tree="$PVIM/config" pull

  if [ "$nvim" != "nvim" ]; then
    downloadAppimage
  fi
}

dashU=false
imageLocation="$PVIM/nvim.appimage"
dashH=false
optrem=1
while getopts ':ui:h' opts; do
  case $opts in
    u)
      dashU=true
      ;;
    i)
      imageLocation="$OPTARG"
      ;;
    h)
      dashH=true
      ;;
    --)
      break
      ;;
    *)
      #Don't shift options that are meant for nvim
      optrem=$((optrem+1))
      ;;
  esac
done
shift $((OPTIND-optrem))

# Determine what Neovim to use
if [ -f "$imageLocation" ]; then
  nvim="$imageLocation"
else
  downloadAppimage
  nvim="$imageLocation"
fi

if $dashH; then
  echo "Usage:
  pvim [options] [neovimOptions]  Edit a file as your would with Neovim

Options:
  --                    Pass all following arguments to Neovim

  -u                    Update pvim, config(if git), and the appimage(if in use)
  -i <appimage>         specify the image path

Use \"pvim -- -h\" to see neovim help"
  exit
fi


if $dashU; then
  updatepvim
fi

# Explicitly use the default config location. In most cases config will be
# cloned separately
export XDG_CONFIG_HOME="$HOME/.config"

# Use this instead to keep config in pvim folder for maximum portability
# export XDG_CONFIG_HOME="$PVIM/config"

# These should override all plugin install locations as well
export XDG_DATA_HOME="$PVIM/clutter/data"
export XDG_STATE_HOME="$PVIM/clutter/state"
export XDG_CACHE_HOME="$PVIM/clutter/cache"

# Run Neovim with the local files
# If using AppImage, try to run directly first, fall back to extracted version if FUSE is not available
if [ "$nvim" = "$imageLocation" ] && [ -f "$imageLocation" ]; then
  # Try to run AppImage directly, but check if we need to extract
  extractedDir="${imageLocation}.extracted"
  extractedBinary="$extractedDir/usr/bin/nvim"
  
  # If already extracted, use that
  if [ -f "$extractedBinary" ]; then
    exec "$extractedBinary" "$@"
  fi
  
  # Try running directly first
  if ! "$nvim" --version >/dev/null 2>&1; then
    # Direct execution failed, likely FUSE issue - extract and use that
    echo "AppImage FUSE mount failed, extracting contents..."
    rm -rf "$extractedDir"
    "$imageLocation" --appimage-extract >/dev/null 2>&1
    # AppImage extracts to ./squashfs-root by default, move it to a consistent location
    if [ -d "./squashfs-root" ]; then
      mv "./squashfs-root" "$extractedDir"
      if [ -f "$extractedBinary" ]; then
        echo "Using extracted Neovim from $extractedDir"
        exec "$extractedBinary" "$@"
      else
        echo "Error: Could not find nvim binary after extraction"
        exit 1
      fi
    else
      echo "Error: AppImage extraction failed"
      exit 1
    fi
  fi
fi

exec "$nvim" "$@"
